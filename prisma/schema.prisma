generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ── Enums ──

enum EventType {
  WEDDING
  ANNIVERSARY
  KIDS
}

enum TemplateCategory {
  FREE
  STANDARD
  PREMIUM
}

enum EventStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum RsvpStatus {
  PENDING
  CONFIRMED
  DECLINED
  MAYBE
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
}

enum MediaType {
  PHOTO
  VIDEO
  MUSIC
}

// ── Models ──

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  passwordHash String
  name         String?
  phone        String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  events         Event[]
  payments       Payment[]
  passwordResets PasswordReset[]
}

model Template {
  id            String           @id @default(cuid())
  name          String
  slug          String           @unique
  eventType     EventType
  category      TemplateCategory
  configJson    Json
  thumbnailUrl  String?
  previewImages String[]
  createdAt     DateTime         @default(now())
  events        Event[]
}

model Event {
  id                String      @id @default(cuid())
  userId            String
  templateId        String
  slug              String      @unique
  title             String
  eventDate         DateTime?
  venueAddress      String?
  venueLat          Float?
  venueLng          Float?
  customizationJson Json        @default("{}")
  musicUrl          String?
  kaspiQrUrl        String?
  status            EventStatus @default(DRAFT)
  publishedAt       DateTime?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  user              User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  template          Template    @relation(fields: [templateId], references: [id])
  guests            Guest[]
  payments          Payment[]
  media             Media[]

  @@index([userId])
  @@index([templateId])
}

model Guest {
  id           String    @id @default(cuid())
  eventId      String
  name         String
  phone        String?
  token        String    @unique @default(uuid())
  tableNumber  Int?
  viewCount    Int       @default(0)
  lastViewedAt DateTime?
  createdAt    DateTime  @default(now())
  event        Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)
  rsvp         Rsvp?

  @@index([eventId])
}

model Rsvp {
  id          String     @id @default(cuid())
  guestId     String     @unique
  status      RsvpStatus @default(PENDING)
  guestCount  Int        @default(1)
  message     String?
  respondedAt DateTime?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  guest       Guest      @relation(fields: [guestId], references: [id], onDelete: Cascade)
}

model Payment {
  id        String        @id @default(cuid())
  userId    String
  eventId   String
  amount    Decimal
  currency  String        @default("KZT")
  kaspiRef  String?
  status    PaymentStatus @default(PENDING)
  createdAt DateTime      @default(now())
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  event     Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([eventId])
}

model PasswordReset {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
}

model Media {
  id           String    @id @default(cuid())
  eventId      String
  type         MediaType
  s3Key        String
  originalName String
  size         Int
  mimeType     String
  createdAt    DateTime  @default(now())
  event        Event     @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}
