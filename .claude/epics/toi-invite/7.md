---
name: Payment & Publishing (Kaspi Pay)
status: open
created: 2026-02-20T15:25:54Z
updated: 2026-02-20T15:48:31Z
github: https://github.com/Temirlaaan/toi-invite/issues/7
depends_on: [8]
parallel: true
conflicts_with: []
---

# Task: Payment & Publishing (Kaspi Pay)

## Description
Implement the payment flow using Kaspi Pay API for template purchases. Enforce the paywall on event publishing — events can only be published (shareable links activated) after successful payment.

## Acceptance Criteria
- [ ] "Publish" button on event builder/dashboard triggers payment flow if unpaid
- [ ] Kaspi Pay order creation via API (amount based on template category: standard/premium pricing)
- [ ] Payment redirect or QR code display for Kaspi Pay checkout
- [ ] Webhook endpoint to receive Kaspi Pay payment confirmation
- [ ] Payment record created in database with status tracking (pending → completed/failed)
- [ ] On successful payment: event status changes from DRAFT to PUBLISHED, slug becomes accessible
- [ ] Published event URL displayed to organizer with copy button
- [ ] Free templates: skip payment, publish directly
- [ ] Payment history visible in dashboard
- [ ] Mock payment mode for development (env flag to bypass Kaspi and auto-complete payment)

## Technical Details
- Kaspi Pay API integration in `src/lib/kaspi.ts`:
  - Create payment order (amount, description, callback URL)
  - Verify payment status
  - Webhook signature validation
- Webhook route: `POST /api/payments/kaspi/webhook` — validates signature, updates Payment record, publishes event
- Publish logic: server action checks Payment exists with status COMPLETED for the event
- Event slug URL only resolves for PUBLISHED events (middleware or page-level check)
- Mock mode: `KASPI_MOCK=true` env var — publish button directly completes payment
- Pricing lookup: Template.category → price mapping in config

## Dependencies
- [ ] Task 8: Events must be created to be published
- [ ] Task 4: Database schema (Payment model)
- [ ] External: Kaspi Pay merchant account (use mock mode until available)

## Effort Estimate
- Size: M
- Hours: 12
- Parallel: true — can be worked on alongside Tasks 10/3/5
