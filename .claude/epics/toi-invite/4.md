---
name: Database Schema & Authentication
status: open
created: 2026-02-20T15:25:54Z
updated: 2026-02-20T15:48:31Z
github: https://github.com/Temirlaaan/toi-invite/issues/4
depends_on: [2]
parallel: false
conflicts_with: []
---

# Task: Database Schema & Authentication

## Description
Define the complete Prisma schema for all data models, run migrations, and set up Auth.js with credentials provider for organizer authentication. Includes sign-up, sign-in, and password reset pages.

## Acceptance Criteria
- [ ] Prisma schema with all models: User, Template, Event, Guest, Rsvp, Payment, Media
- [ ] Migrations generated and applied to PostgreSQL
- [ ] Auth.js (NextAuth v5) configured with credentials provider (email + password)
- [ ] Password hashing with bcrypt
- [ ] Sign-up page (`/[locale]/auth/signup`) with email, name, phone, password
- [ ] Sign-in page (`/[locale]/auth/signin`) with email + password
- [ ] Password reset flow (token-based, email placeholder — actual email sending out of scope)
- [ ] Auth middleware protecting `/dashboard/*` routes
- [ ] Session accessible in server components and API routes

## Technical Details
- Prisma schema models (see epic for full field definitions):
  - `User`: id, email (unique), passwordHash, name, phone, createdAt, updatedAt
  - `Template`: id, name, slug (unique), eventType (enum: WEDDING/ANNIVERSARY/KIDS), category (enum: FREE/STANDARD/PREMIUM), configJson (Json), thumbnailUrl, previewImages (String[]), createdAt
  - `Event`: id, userId (FK), templateId (FK), slug (unique), title, eventDate, venueAddress, venueLat, venueLng, customizationJson (Json), musicUrl, kaspiQrUrl, status (enum: DRAFT/PUBLISHED/ARCHIVED), publishedAt, createdAt, updatedAt
  - `Guest`: id, eventId (FK), name, phone, token (unique, default uuid), viewCount (default 0), lastViewedAt, createdAt
  - `Rsvp`: id, guestId (FK, unique), status (enum: PENDING/CONFIRMED/DECLINED/MAYBE), guestCount (default 1), message, respondedAt, createdAt, updatedAt
  - `Payment`: id, userId (FK), eventId (FK), amount (Decimal), currency (default "KZT"), kaspiRef, status (enum: PENDING/COMPLETED/FAILED), createdAt
  - `Media`: id, eventId (FK), type (enum: PHOTO/VIDEO/MUSIC), s3Key, originalName, size (Int), mimeType, createdAt
- Auth.js `auth.ts` config at project root
- Use `@auth/prisma-adapter` for session storage
- Auth pages use shadcn/ui form components
- Middleware in `middleware.ts` for route protection

## Dependencies
- [ ] Task 2: Project setup must be complete

## Effort Estimate
- Size: M
- Hours: 8
- Parallel: false — schema must exist before other tasks
